<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日本語対応Markdownエディタ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css" id="highlight-theme">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Noto Sans JP', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            min-height: 100vh;
            font-size: 16px;
            transition: background-color 0.3s, color 0.3s;
        }
        body.dark {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 40px);
        }
        .toolbar {
            background-color: #fff;
            padding: 12px;
            border-radius: 8px;
            display: flex;
            flex-wrap: nowrap;
            gap: 8px;
            overflow-x: auto;
            position: sticky;
            top: 10px;
            z-index: 10;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        body.dark .toolbar {
            background-color: #2d2d2d;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        .toolbar button {
            padding: 8px;
            border: none;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            min-width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        body.dark .toolbar button {
            background-color: #1e90ff;
        }
        .toolbar button:hover {
            background-color: #0056b3;
        }
        .toolbar button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .editor-container {
            display: flex;
            flex: 1;
            gap: 15px;
            margin-top: 15px;
            overflow: hidden;
        }
        .editor, .preview {
            flex: 1;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            overflow-y: auto;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        body.dark .editor, body.dark .preview {
            background-color: #2d2d2d;
            color: #e0e0e0;
        }
        .editor {
            min-height: 500px;
            outline: none;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.7;
            font-size: 16px;
        }
        .preview {
            font-family: 'Noto Sans JP', monospace;
            white-space: pre-wrap;
            line-height: 1.7;
            font-size: 15px;
        }
        .preview pre code {
            font-size: 14px;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }
        .action-buttons button {
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        #copy-btn {
            background-color: #28a745;
            color: white;
        }
        #copy-btn:hover {
            background-color: #218838;
        }
        #export-btn {
            background-color: #6c757d;
            color: white;
        }
        #export-btn:hover {
            background-color: #5a6268;
        }
        #theme-toggle {
            background-color: #ffc107;
            color: #000;
        }
        #theme-toggle:hover {
            background-color: #e0a800;
        }
        select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: #fff;
        }
        body.dark select {
            background-color: #2d2d2d;
            color: #e0e0e0;
            border-color: #444;
        }
        @media (max-width: 768px) {
            .editor-container {
                flex-direction: column;
            }
            .preview {
                margin-top: 15px;
            }
            .toolbar {
                flex-wrap: nowrap;
                overflow-x: auto;
                padding-bottom: 10px;
            }
            .toolbar button {
                min-width: 36px;
                font-size: 12px;
                padding: 6px;
            }
            .editor, .preview {
                font-size: 14px;
            }
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="toolbar">
            <button onclick="format('bold')" title="太字 (Ctrl+B)"><i class="fas fa-bold"></i></button>
            <button onclick="format('italic')" title="斜体 (Ctrl+I)"><i class="fas fa-italic"></i></button>
            <button onclick="format('underline')" title="下線 (Ctrl+U)"><i class="fas fa-underline"></i></button>
            <button onclick="format('strikeThrough')" title="取り消し線"><i class="fas fa-strikethrough"></i></button>
            <button onclick="formatHeading(1)" title="見出し1 (#)">H1</button>
            <button onclick="formatHeading(2)" title="見出し2 (##)">H2</button>
            <button onclick="formatHeading(3)" title="見出し3 (###)">H3</button>
            <button onclick="format('insertUnorderedList')" title="箇条書き"><i class="fas fa-list-ul"></i></button>
            <button onclick="format('insertOrderedList')" title="番号付きリスト"><i class="fas fa-list-ol"></i></button>
            <button onclick="format('indent')" title="インデント"><i class="fas fa-indent"></i></button>
            <button onclick="format('outdent')" title="インデント解除"><i class="fas fa-outdent"></i></button>
            <button onclick="insertLink()" title="リンク挿入"><i class="fas fa-link"></i></button>
            <button onclick="insertImage()" title="画像挿入"><i class="fas fa-image"></i></button>
            <button onclick="insertCodeBlock()" title="コードブロック"><i class="fas fa-code"></i></button>
            <button onclick="insertBlockquote()" title="引用"><i class="fas fa-quote-left"></i></button>
            <button onclick="insertHorizontalRule()" title="水平線"><i class="fas fa-minus"></i></button>
            <button onclick="insertTable()" title="表を挿入"><i class="fas fa-table"></i></button>
            <button onclick="insertTaskList()" title="タスクリスト"><i class="fas fa-tasks"></i></button>
            <button onclick="format('undo')" title="元に戻す (Ctrl+Z)"><i class="fas fa-undo"></i></button>
            <button onclick="format('redo')" title="やり直し (Ctrl+Y)"><i class="fas fa-redo"></i></button>
            <select onchange="changeFontSize(this.value)" title="フォントサイズ">
                <option value="14">14px</option>
                <option value="16" selected>16px</option>
                <option value="18">18px</option>
                <option value="20">20px</option>
            </select>
        </div>
        <div class="editor-container">
            <div id="editor" contenteditable="true" class="editor">ここにテキストを入力して、Markdownを簡単に作成！</div>
            <div id="preview" class="preview"></div>
        </div>
        <div class="action-buttons">
            <button id="copy-btn" onclick="copyMarkdown()">Markdownをコピー</button>
            <button id="export-btn" onclick="exportMarkdown()">Markdownをエクスポート</button>
            <button id="theme-toggle" onclick="toggleTheme()">ダークモード切替</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script>
        // 初期化
        hljs.highlightAll();
        let isDarkMode = false;

        function format(command) {
            document.execCommand(command, false, null);
            updatePreview();
        }

        function formatHeading(level) {
            document.execCommand('formatBlock', false, `h${level}`);
            updatePreview();
        }

        function insertLink() {
            const url = prompt('リンクのURLを入力してください:');
            if (url) {
                const text = document.getSelection().toString() || 'リンク';
                document.execCommand('insertHTML', false, `<a href="${url}">${text}</a>`);
                updatePreview();
            }
        }

        function insertImage() {
            const url = prompt('画像のURLを入力してください:') || '';
            if (url) {
                document.execCommand('insertHTML', false, `<img src="${url}" alt="画像" style="max-width:100%;">`);
                updatePreview();
            }
        }

        function insertCodeBlock() {
            const lang = prompt('コードの言語を入力してください (例: javascript, python):') || '';
            const code = prompt('コードを入力してください:') || 'コード例';
            const html = `<pre><code class="language-${lang}">${code.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code></pre>`;
            document.execCommand('insertHTML', false, html);
            updatePreview();
        }

        function insertBlockquote() {
            document.execCommand('formatBlock', false, 'blockquote');
            updatePreview();
        }

        function insertHorizontalRule() {
            document.execCommand('insertHorizontalRule');
            updatePreview();
        }

        function insertTable() {
            const rows = parseInt(prompt('行数を入力してください (例: 2):') || 2);
            const cols = parseInt(prompt('列数を入力してください (例: 2):') || 2);
            if (rows > 0 && cols > 0) {
                let tableHTML = '<table border="1" style="border-collapse: collapse; width: 100%;">';
                tableHTML += '<tr>' + '<th>ヘッダ</th>'.repeat(cols) + '</tr>';
                for (let i = 0; i < rows - 1; i++) {
                    tableHTML += '<tr>' + '<td>内容</td>'.repeat(cols) + '</tr>';
                }
                tableHTML += '</table>';
                document.execCommand('insertHTML', false, tableHTML);
                updatePreview();
            }
        }

        function insertTaskList() {
            const items = prompt('タスクリストの項目をカンマで区切って入力してください (例: タスク1,タスク2):')?.split(',') || ['タスク1'];
            let html = '<ul>';
            items.forEach(item => {
                html += `<li><input type="checkbox"> ${item.trim()}</li>`;
            });
            html += '</ul>';
            document.execCommand('insertHTML', false, html);
            updatePreview();
        }

        function changeFontSize(size) {
            document.getElementById('editor').style.fontSize = `${size}px`;
            document.getElementById('preview').style.fontSize = `${size - 1}px`;
        }

        function htmlToMarkdown(html) {
            let md = html
                // 見出し
                .replace(/<h1>(.*?)<\/h1>/g, '# $1\n\n')
                .replace(/<h2>(.*?)<\/h2>/g, '## $1\n\n')
                .replace(/<h3>(.*?)<\/h3>/g, '### $1\n\n')
                // テキスト装飾
                .replace(/<b>(.*?)<\/b>/g, '**$1**')
                .replace(/<strong>(.*?)<\/strong>/g, '**$1**')
                .replace(/<i>(.*?)<\/i>/g, '*$1*')
                .replace(/<em>(.*?)<\/em>/g, '*$1*')
                .replace(/<u>(.*?)<\/u>/g, '<u>$1</u>')
                .replace(/<strike>(.*?)<\/strike>/g, '~~$1~~')
                .replace(/<del>(.*?)<\/del>/g, '~~$1~~')
                // リスト
                .replace(/<ul>(.*?)<\/ul>/gs, (match, content) => {
                    return content
                        .replace(/<li><input type="checkbox"[^>]*>\s*(.*?)<\/li>/g, '- [ ] $1\n')
                        .replace(/<li>(.*?)<\/li>/g, '- $1\n') + '\n';
                })
                .replace(/<ol>(.*?)<\/ol>/gs, (match, content) => {
                    let count = 1;
                    return content.replace(/<li>(.*?)<\/li>/g, () => `${count++}. $1\n`) + '\n';
                })
                // リンクと画像
                .replace(/<a href="(.*?)">(.*?)<\/a>/g, '[$2]($1)')
                .replace(/<img src="(.*?)" alt="(.*?)"[^>]*>/g, '![$2]($1)')
                // コード
                .replace(/<pre><code class="language-(.*?)"[^>]*>(.*?)<\/code><\/pre>/gs, '```$1\n$2\n```\n')
                .replace(/<pre><code>(.*?)<\/code><\/pre>/gs, '```\n$1\n```\n')
                .replace(/<code>(.*?)<\/code>/g, '`$1`')
                // 引用
                .replace(/<blockquote>(.*?)<\/blockquote>/gs, (match, content) => {
                    return '> ' + content.replace(/\n/g, '\n> ') + '\n\n';
                })
                // 水平線
                .replace(/<hr>/g, '---\n')
                // 表
                .replace(/<table[^>]*>(.*?)<\/table>/gs, (match, content) => {
                    let rows = content.match(/<tr>(.*?)<\/tr>/g);
                    if (!rows) return '';
                    let mdTable = '';
                    rows.forEach((row, index) => {
                        let cells = row.match(/<(td|th)>(.*?)<\/(td|th)>/g);
                        if (cells) {
                            mdTable += '| ' + cells.map(cell => cell.replace(/<(td|th)>(.*?)<\/(td|th)>/, '$2').trim()).join(' | ') + ' |\n';
                            if (index === 0) {
                                mdTable += '| ' + cells.map(() => '---').join(' | ') + ' |\n';
                            }
                        }
                    });
                    return mdTable + '\n';
                })
                // その他
                .replace(/<p>(.*?)<\/p>/g, '$1\n\n')
                .replace(/<br>/g, '\n')
                .replace(/&nbsp;/g, ' ')
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/\n\s*\n\s*\n+/g, '\n\n')
                .trim();
            return md;
        }

        function updatePreview() {
            const editor = document.getElementById('editor');
            const preview = document.getElementById('preview');
            preview.innerHTML = `<pre><code class="language-markdown">${htmlToMarkdown(editor.innerHTML)}</code></pre>`;
            hljs.highlightAll();
        }

        function copyMarkdown() {
            const preview = document.getElementById('preview').textContent;
            navigator.clipboard.writeText(preview).then(() => {
                alert('Markdownをクリップボードにコピーしました！');
            });
        }

        function exportMarkdown() {
            const preview = document.getElementById('preview').textContent;
            const blob = new Blob([preview], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'document.md';
            a.click();
            URL.revokeObjectURL(url);
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark');
            const themeLink = document.getElementById('highlight-theme');
            themeLink.href = isDarkMode
                ? 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css'
                : 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css';
            document.getElementById('theme-toggle').innerHTML = isDarkMode ? 'ライトモード' : 'ダークモード';
        }

        // イベントリスナー
        const editor = document.getElementById('editor');
        editor.addEventListener('input', updatePreview);
        editor.addEventListener('paste', (e) => {
            e.preventDefault();
            const text = (e.clipboardData || window.clipboardData).getData('text');
            document.execCommand('insertText', false, text);
        });

        // ドラッグ＆ドロップで画像挿入
        editor.addEventListener('dragover', (e) => e.preventDefault());
        editor.addEventListener('drop', (e) => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = () => {
                    document.execCommand('insertHTML', false, `<img src="${reader.result}" alt="画像" style="max-width:100%;">`);
                    updatePreview();
                };
                reader.readAsDataURL(file);
            }
        });

        // ショートカットキー
        editor.addEventListener('keydown', (e) => {
            if (e.ctrlKey) {
                switch (e.key) {
                    case 'b': e.preventDefault(); format('bold'); break;
                    case 'i': e.preventDefault(); format('italic'); break;
                    case 'u': e.preventDefault(); format('underline'); break;
                    case 'z': e.preventDefault(); format('undo'); break;
                    case 'y': e.preventDefault(); format('redo'); break;
                }
            }
        });

        // 初期プレビュー
        updatePreview();
    </script>
</body>
</html>
